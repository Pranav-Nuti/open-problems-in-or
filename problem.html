<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Problem</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
</head>
<body>
  <header class="site-header">
    <h1 class="site-title"><a href="index.html">Open Problems in Operations Research</a></h1>
  </header>

  <main>
    <a href="index.html" class="back-link">← Back to all problems</a>

    <div class="problem-header">
      <div class="problem-id" id="problem-id">Problem</div>
      <h1 class="problem-title" id="problem-title">Loading...</h1>
      <div class="problem-meta-grid">
        <div class="problem-meta-item">
          <span class="problem-meta-label">Source paper</span>
          <span class="problem-meta-value" id="source-paper"></span>
        </div>
        <div class="problem-meta-item">
          <span class="problem-meta-label">Extracted with</span>
          <span class="problem-meta-value" id="extraction-info"></span>
        </div>
        <div class="problem-meta-item">
          <span class="problem-meta-label">Subject classification</span>
          <span class="problem-meta-value" id="subject-classification"></span>
        </div>
        <div class="problem-meta-item">
          <span class="problem-meta-label">Importance / Difficulty</span>
          <span class="problem-meta-value" id="importance-difficulty"></span>
        </div>
        <div class="problem-meta-item">
          <span class="problem-meta-label">Verification status</span>
          <span class="problem-meta-value" id="verification-status"></span>
        </div>
      </div>
    </div>

    <section class="problem-section">
      <h2>Problem statement (LaTeX)</h2>
      <div id="problem-latex"></div>
    </section>

    <section class="problem-section">
      <h2>Context</h2>
      <p id="problem-context"></p>
    </section>

    <section class="problem-section">
      <h2>Keywords</h2>
      <p id="problem-keywords"></p>
    </section>

    <section class="problem-section">
      <h2>Literature review</h2>
      <div id="literature-review"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-maintainers">Maintainers: Eric Fithian, Rad Niazadeh, Pranav Nuti</div>
      <div>Open Problems in Operations Research</div>
    </div>
  </footer>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
  <script>
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = String(text ?? "");
      return div.innerHTML;
    }

    function getProblemId() {
      const params = new URLSearchParams(window.location.search);
      const problemId = params.get("id");
      if (!problemId) {
        throw new Error("Missing query parameter: id");
      }
      return problemId;
    }

    async function loadProblem(problemId) {
      const response = await fetch(`data/llm_math_export/problems/${encodeURIComponent(problemId)}.json`);
      if (!response.ok) {
        throw new Error(`Failed to load problem ${problemId}: ${response.status}`);
      }
      return await response.json();
    }

    function renderLiterature(payload) {
      const container = document.getElementById("literature-review");
      const review = payload.literature_review;
      if (!review || !Array.isArray(review.sources) || review.sources.length === 0) {
        container.innerHTML = "<p>No literature review available.</p>";
        return;
      }
      container.innerHTML = review.sources.map((source, idx) => `
        <div class="problem-card math-content" style="margin-bottom:1rem;">
          <div class="problem-card-id">Source #${idx + 1} · ${escapeHtml(source.relevance_category)}</div>
          <p><strong>BibTeX</strong><br><code>${escapeHtml(source.bibtex)}</code></p>
          <p><strong>Theorem/result</strong><br><span class="math-inline">${escapeHtml(source.theorem_or_result)}</span></p>
          <p><strong>Connection</strong><br><span class="math-inline">${escapeHtml(source.connection)}</span></p>
        </div>
      `).join("");
    }

    function renderSourcePaper(payload) {
      const el = document.getElementById("source-paper");
      const title = payload.source_paper_title || payload.source_paper || payload.paper_id || "";
      const url = payload.source_paper_url || "";
      if (url) {
        el.innerHTML = `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>`;
      } else {
        el.textContent = title;
      }
    }

    function renderExtractionInfo(payload) {
      const model = payload.extraction_model || "";
      const effort = payload.extraction_reasoning_effort || "";
      const parts = [model, effort].filter(Boolean);
      document.getElementById("extraction-info").textContent = parts.length ? parts.join(", reasoning: ") : "—";
    }

    function preprocessProblemLatex(latex) {
      let s = latex
        .replace(/\\begin\{problem\}(\[[^\]]*\])?\s*/g, "")
        .replace(/\\end\{problem\}\s*/g, "")
        .replace(/\\begin\{itemize\}\s*/g, "")
        .replace(/\\end\{itemize\}\s*/g, "")
        .replace(/\\item\s+/g, "\n• ")
        .replace(/\\medskip\s*/g, "\n\n")
        .replace(/\\noindent\s*/g, "");
      s = s.replace(/\\textbf\{([^{}]*)\}/g, (_, c) => "__B__" + escapeHtml(c) + "__EB__");
      s = s.replace(/\\emph\{([^{}]*)\}/g, (_, c) => "__E__" + escapeHtml(c) + "__EE__");
      s = escapeHtml(s);
      return s.replace(/__B__/g, "<strong>").replace(/__EB__/g, "</strong>")
        .replace(/__E__/g, "<em>").replace(/__EE__/g, "</em>");
    }

    function renderProblem(payload) {
      document.title = `${payload.title} | Open Problems in OR`;
      document.getElementById("problem-id").textContent = payload.problem_id;
      document.getElementById("problem-title").textContent = payload.title;
      renderSourcePaper(payload);
      renderExtractionInfo(payload);
      document.getElementById("subject-classification").textContent = payload.subject_classification || "";
      const impScale = payload.importance_scale ?? 10;
      const diffScale = payload.difficulty_scale ?? 10;
      document.getElementById("importance-difficulty").textContent = `Importance: ${payload.importance}/${impScale}, Difficulty: ${payload.difficulty}/${diffScale}`;
      document.getElementById("verification-status").textContent = payload.verification?.is_open ? "Open" : "Closed";
      const latexEl = document.getElementById("problem-latex");
      const latex = payload.latex || "";
      latexEl.innerHTML = latex ? preprocessProblemLatex(latex) : "";
      latexEl.classList.add("math-content");
      const contextEl = document.getElementById("problem-context");
      contextEl.innerHTML = escapeHtml(payload.context || "");
      contextEl.classList.add("math-content");
      document.getElementById("problem-keywords").textContent = Array.isArray(payload.keywords) ? payload.keywords.join(", ") : "";
      renderLiterature(payload);
    }

    async function boot() {
      try {
        const problemId = getProblemId();
        const payload = await loadProblem(problemId);
        renderProblem(payload);
        if (typeof renderMathInElement === "function") {
          renderMathInElement(document.body, {
            delimiters: [
              { left: "$$", right: "$$", display: true },
              { left: "\\[", right: "\\]", display: true },
              { left: "$", right: "$", display: false },
              { left: "\\(", right: "\\)", display: false }
            ],
            throwOnError: false
          });
        }
      } catch (err) {
        document.getElementById("problem-title").textContent = "Unable to load problem";
        document.getElementById("problem-context").textContent = err.message;
      }
    }

    window.addEventListener("load", boot);
  </script>
</body>
</html>
